/* ================= Mapeamento flexível de cabeçalhos ================= */
// ATUALIZADO: Adicionando a nova coluna QOE Pós 24h
const AUTO_MAP={
  'INCIDENTE':'INCIDENTE',
  'CIDADE':'Cidade',
  'CLUSTER':'Cluster',
  'HI (DATA E HORA INÍCIO)':'Data',
  'HI (DATA E HORA INICIO)':'Data',
  'HI_INICIO':'Data',
  'HI INICIO':'Data',
  'HI INÍCIO':'Data',
  'DATA':'Data',
  'NODE':'Node',
  'QOE PRÉ':'QOE_Pre',
  'QOE PRE':'QOE_Pre',
  'QOE_PRE':'QOE_Pre',
  'QOE PÓS':'QOE_Pos',
  'QOE POS':'QOE_Pos',
  'QOE_POS':'QOE_Pos',
  'QOE PÓS 24H':'QOE_Pos_24h',  // NOVA COLUNA
  'QOE POS 24H':'QOE_Pos_24h',  // NOVA COLUNA
  'QOE_POS_24H':'QOE_Pos_24h',  // NOVA COLUNA
  'SOLUÇÃO':'Tipo_Fechamento',
  'SOLUCAO':'Tipo_Fechamento',
  'TIPO_FECHAMENTO':'Tipo_Fechamento'
};

/* ================= Proteções QOE - ATUALIZADO ================= */
function safeVarPct(qpre, qpos, qpos24h = null){
  if(!isFinite(qpre) || qpre <= 0) return 0;
  
  // Se temos QOE Pós 24h, calcula a variação considerando as três métricas
  if (qpos24h !== null && isFinite(qpos24h)) {
    // Média ponderada ou lógica específica - ajuste conforme necessidade
    return ((qpos24h - qpre) / qpre) * 100;
  }
  
  // Fallback para cálculo original se não houver QOE Pós 24h
  return ((qpos - qpre) / qpre) * 100;
}

function fmtPct(n){
  if(!isFinite(n) || Math.abs(n) > 1000) return '—';
  return `${n.toFixed(1)}%`;
}

function fmtNum(n){ return isFinite(n) ? n.toFixed(1) : '—'; }

/* ================= Leitura robusta da planilha - ATUALIZADO ================= */
function handleFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=new Uint8Array(e.target.result);
      const wb=XLSX.read(data,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const json=XLSX.utils.sheet_to_json(ws,{defval:'',header:1});

      let headerRowIndex = json.findIndex(row => Array.isArray(row) && row.some(cell => String(cell).trim() !== ''));
      if (headerRowIndex === -1) { 
        showToast('❌ Planilha vazia ou inválida', 'danger');
        return; 
      }

      const rawHeader = (json[headerRowIndex]||[]).map(normalizeHeader);
      const mappedHeader = rawHeader.map(h => AUTO_MAP[h] || h);

      // DEBUG: Mostrar mapeamento no console
      console.log('Cabeçalhos originais:', rawHeader);
      console.log('Cabeçalhos mapeados:', mappedHeader);

      const dataRows = json.slice(headerRowIndex+1).filter(r => Array.isArray(r) && r.some(cell => String(cell).trim() !== ''));

      const rows = dataRows.map(r => {
        const o={};
        mappedHeader.forEach((h,i)=>o[h]=r[i]);
        
        // Conversões/limpezas - ATUALIZADO com nova coluna
        o['Data'] = validarData(String(o['Data'] || ''));
        
        // QOE Pré
        o['QOE_Pre']=Number(String(o['QOE_Pre']||'0').toString().replace(',','.')); 
        if(!isFinite(o['QOE_Pre'])) o['QOE_Pre']=0;
        
        // QOE Pós
        o['QOE_Pos']=Number(String(o['QOE_Pos']||'0').toString().replace(',','.')); 
        if(!isFinite(o['QOE_Pos'])) o['QOE_Pos']=0;
        
        // QOE Pós 24h - NOVA COLUNA
        o['QOE_Pos_24h']=Number(String(o['QOE_Pos_24h']||'0').toString().replace(',','.')); 
        if(!isFinite(o['QOE_Pos_24h'])) o['QOE_Pos_24h']=0;
        
        // Mapear campos de texto
        ['Cluster','Node','Cidade','Tipo_Fechamento','INCIDENTE'].forEach(k=>{
          o[k]=String(o[k]||'').trim();
          if(o[k]==='') o[k]='(não informado)';
        });
        
        return o;
      });

      if(rows.length===0){ 
        showToast('⚠️ Nenhum registro válido encontrado na planilha.', 'warning'); 
        return; 
      }

      DATA_ALL=rows; RAW=[...rows];
      
      // DEBUG: Mostrar primeiras linhas processadas
      console.log('Primeiras 3 linhas processadas:', rows.slice(0, 3));
      
      renderAll();
      showToast(`✅ ${rows.length} incidentes carregados com sucesso`, 'success');
    }catch(err){
      console.error(err);
      showToast('❌ Erro ao processar a planilha. Verifique o formato e tente novamente.', 'danger');
    }
  };
  reader.readAsArrayBuffer(file);
}

/* ================= QOE - ATUALIZADO ================= */
function colorByValue(v){
  if(!isFinite(v)) return '';
  if(v <= 40) return 'text-danger fw-bold';
  if(v <= 80) return 'text-warning fw-bold';
  return 'text-success fw-bold';
}

function aggregateQoe(rows,keys){
  const map=new Map();
  rows.forEach(r=>{
    const k=keys.map(k=>r[k]||'').join('||');
    const acc=map.get(k)||{
      cnt:0,
      qpre:0,
      qpos:0,
      qpos24h:0,  // NOVO
      Node:r.Node||'',
      Cluster:r.Cluster||'',
      Cidade:r.Cidade||''
    };
    acc.cnt++; 
    acc.qpre+=isFinite(r.QOE_Pre)?r.QOE_Pre:0; 
    acc.qpos+=isFinite(r.QOE_Pos)?r.QOE_Pos:0;
    acc.qpos24h+=isFinite(r.QOE_Pos_24h)?r.QOE_Pos_24h:0;  // NOVO
    map.set(k,acc);
  });
  
  return Array.from(map.values()).map(v=>{
    const pre=v.cnt?v.qpre/v.cnt:0;
    const pos=v.cnt?v.qpos/v.cnt:0;
    const pos24h=v.cnt?v.qpos24h/v.cnt:0;  // NOVO
    
    return {
      ...v,
      qoePre:pre,
      qoePos:pos,
      qoePos24h:pos24h,  // NOVO
      varPct:safeVarPct(pre, pos, pos24h)  // ATUALIZADO
    };
  });
}

function renderQoe(){
  const arr=aggregateQoe(RAW,['Node','Cluster','Cidade']);
  
  // ATUALIZANDO A TABELA PARA MOSTRAR AS TRÊS MÉTRICAS
  $('#tblQoeNode thead tr').innerHTML = `
    <th>Node</th>
    <th>Cluster</th>
    <th>Cidade</th>
    <th class="text-end"><strong>Pré</strong></th>
    <th class="text-end"><strong>Pós</strong></th>
    <th class="text-end"><strong>Pós 24h</strong></th>  <!-- NOVA COLUNA -->
    <th class="text-end">Variação</th>
    <th>Status</th>
  `;
  
  $('#tblQoeNode tbody').innerHTML = arr.map(r=>{
    const arrow = r.varPct > 1 ? 
      '<span class="text-success fw-bold"><i class="bi bi-arrow-up"></i></span>' : 
      '<span class="text-danger fw-bold"><i class="bi bi-arrow-down"></i></span>';
    
    const status = r.varPct > 1 ? 
      '<span class="status-badge badge-success">Melhoria</span>' : 
      '<span class="status-badge badge-danger">Piora/Estável</span>';
    
    return `<tr class="slide-in-up">
      <td>${r.Node}</td>
      <td>${r.Cluster}</td>
      <td>${r.Cidade}</td>
      <td class="text-end ${colorByValue(r.qoePre)}">${fmtNum(r.qoePre)}</td>
      <td class="text-end ${colorByValue(r.qoePos)}">${fmtNum(r.qoePos)}</td>
      <td class="text-end ${colorByValue(r.qoePos24h)}">${fmtNum(r.qoePos24h)}</td>  <!-- NOVA COLUNA -->
      <td class="text-end">${arrow} ${fmtPct(r.varPct)}</td>
      <td>${status}</td>
    </tr>`;
  }).join('');
}

/* ================= Reincidência - ATUALIZADO ================= */
function renderReinc(){
  const byNode = groupBy(RAW, 'Node');
  const reinc = Object.entries(byNode)
    .filter(([_, list]) => list.length > 1)
    .map(([n, l]) => ({
      Node: n, 
      Cluster: l[0].Cluster, 
      Cidade: l[0].Cidade, 
      Count: l.length,
      Incidents: l.map(x => ({
        solucao: x.Tipo_Fechamento || '(sem solução)',
        data: x.Data ? formatarData(x.Data) : '(sem data)',
        dataOriginal: x.Data,
        qoePre: x.QOE_Pre || 0,
        qoePos: x.QOE_Pos || 0,
        qoePos24h: x.QOE_Pos_24h || 0,  // NOVO
        cluster: x.Cluster || '',
        cidade: x.Cidade || '',
        incidente: x.INCIDENTE || ''
      }))
    })).sort((a, b) => b.Count - a.Count);

  const tbody = $('#tblReinc tbody'); 
  tbody.innerHTML = '';
  
  reinc.forEach((r, index) => {
    const tr = document.createElement('tr'); 
    tr.className = 'pointer slide-in-up';
    tr.style.animationDelay = `${index * 0.1}s`;
    tr.setAttribute('data-node', r.Node);
    tr.innerHTML = `
      <td>
        <div class="d-flex align-items-center">
          <i class="bi bi-chevron-right me-2 expand-icon" style="font-size: 0.8rem; transition: transform 0.3s ease;"></i>
          ${r.Node}
        </div>
      </td>
      <td>${r.Cluster}</td>
      <td>${r.Cidade}</td>
      <td class="text-center">
        <span class="badge bg-danger rounded-pill">${r.Count} ocorrências</span>
      </td>`;
    
    tr.addEventListener('click', (e) => {
      if (!e.target.classList.contains('expand-icon')) {
        toggleDetalhesNode(tr, r);
      }
    });
    
    const expandIcon = tr.querySelector('.expand-icon');
    expandIcon.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleDetalhesNode(tr, r);
    });
    
    tbody.appendChild(tr);
  });
}

/* ================= Toggle Detalhes - ATUALIZADO ================= */
function toggleDetalhesNode(tr, nodeData){
  const expandIcon = tr.querySelector('.expand-icon');
  const nodeName = nodeData.Node;
  
  const existingDetails = $(`tr.details-row[data-node="${nodeName}"]`);
  
  if (existingDetails) {
    existingDetails.remove();
    expandIcon.classList.remove('bi-chevron-down');
    expandIcon.classList.add('bi-chevron-right');
    tr.classList.remove('table-active');
  } else {
    $$('#tblReinc .details-row').forEach(row => row.remove());
    $$('#tblReinc .expand-icon').forEach(icon => {
      icon.classList.remove('bi-chevron-down');
      icon.classList.add('bi-chevron-right');
    });
    $$('#tblReinc tr').forEach(row => row.classList.remove('table-active'));
    
    const detailsRow = document.createElement('tr');
    detailsRow.className = 'details-row slide-in-up';
    detailsRow.setAttribute('data-node', nodeName);
    
    detailsRow.innerHTML = `
      <td colspan="4" class="p-0 border-0">
        <div class="details-content bg-light p-4">
          <div class="row">
            <div class="col-12">
              <h6 class="text-primary mb-3">
                <i class="bi bi-list-ul me-2"></i>
                Detalhes dos Incidentes - ${nodeData.Node}
                <small class="text-muted ms-2">(${nodeData.Count} ocorrências)</small>
              </h6>
            </div>
          </div>
          <div class="row">
            ${nodeData.Incidents.map((inc, index) => `
              <div class="col-12 col-md-6 col-lg-4 mb-3">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-header bg-white py-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-primary">#${index + 1}</span>
                      <small class="text-muted">${inc.data}</small>
                    </div>
                    ${inc.incidente ? `<small class="text-muted d-block mt-1">Incidente: ${inc.incidente}</small>` : ''}
                  </div>
                  <div class="card-body p-3">
                    <div class="mb-2">
                      <strong class="text-dark">Solução:</strong>
                      <span class="ms-2">${inc.solucao}</span>
                    </div>
                    <div class="mb-2">
                      <strong class="text-dark">QOE:</strong>
                      <span class="ms-2">
                        <span class="${inc.qoePre > 80 ? 'text-success' : inc.qoePre > 60 ? 'text-warning' : 'text-danger'}">
                          ${inc.qoePre.toFixed(1)}
                        </span>
                        <i class="bi bi-arrow-right mx-1 text-muted"></i>
                        <span class="${inc.qoePos > 80 ? 'text-success' : inc.qoePos > 60 ? 'text-warning' : 'text-danger'}">
                          ${inc.qoePos.toFixed(1)}
                        </span>
                        <i class="bi bi-arrow-right mx-1 text-muted"></i>
                        <span class="${inc.qoePos24h > 80 ? 'text-success' : inc.qoePos24h > 60 ? 'text-warning' : 'text-danger'}">
                          ${inc.qoePos24h.toFixed(1)}
                        </span>
                        <small class="text-muted ms-1">(24h)</small>
                      </span>
                    </div>
                    <div class="mb-0">
                      <strong class="text-dark">Local:</strong>
                      <span class="ms-2">${inc.cidade} / ${inc.cluster}</span>
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </td>
    `;
    
    tr.insertAdjacentElement('afterend', detailsRow);
    expandIcon.classList.remove('bi-chevron-right');
    expandIcon.classList.add('bi-chevron-down');
    tr.classList.add('table-active');
    
    detailsRow.style.opacity = '0';
    detailsRow.style.transform = 'translateY(-10px)';
    setTimeout(() => {
      detailsRow.style.transition = 'all 0.3s ease';
      detailsRow.style.opacity = '1';
      detailsRow.style.transform = 'translateY(0)';
    }, 10);
  }
}

/* ================= Dashboard - ATUALIZADO ================= */
function renderResumo(){
  const byCluster=groupBy(RAW,'Cluster');
  const wrap=$('#cardsResumo'); wrap.innerHTML='';
  Object.entries(byCluster).forEach(([cl,rows], index) => {
    const total=rows.length;
    const nodes=groupBy(rows,'Node');
    const reinc=Object.values(nodes).filter(a=>a.length>1).length;
    const taxa=total?(reinc/Object.keys(nodes).length*100):0;
    
    // ATUALIZADO: Agora usa a nova lógica com QOE Pós 24h
    const varPct=aggregateQoe(rows,['Cluster'])[0]?.varPct||0;
    const qClass=varPct>0?'text-success fw-bold':'text-danger fw-bold';
    const rClass=taxa>20?'text-danger':'text-success';

    const card=document.createElement('div'); 
    card.className='col-12 col-md-6 col-lg-4';
    card.style.animationDelay = `${index * 0.1}s`;
    card.innerHTML = `
      <div class="card-custom h-100 p-4">
        <div class="card-body p-0">
          <h5 class="mb-3 section-title">${cl}</h5>
          <div class="d-flex align-items-center mb-3">
            <div class="me-3">
              <i class="bi bi-exclamation-circle fs-4 text-primary"></i>
            </div>
            <div>
              <div class="text-muted small">Total de Incidentes</div>
              <div class="h4 mb-0 fw-bold">${total}</div>
            </div>
          </div>
          <div class="d-flex align-items-center mb-3">
            <div class="me-3">
              <i class="bi bi-arrow-left-right fs-4 ${qClass.replace('fw-bold', '')}"></i>
            </div>
            <div>
              <div class="text-muted small">Variação QOE</div>
              <div class="h5 mb-0 ${qClass}">${fmtPct(varPct)}</div>
            </div>
          </div>
          <div class="d-flex align-items-center">
            <div class="me-3">
              <i class="bi bi-clock-history fs-4 ${rClass.replace('text-danger', 'text-warning').replace('text-success', 'text-info')}"></i>
            </div>
            <div>
              <div class="text-muted small">Taxa de Reincidência</div>
              <div class="h5 mb-0 ${rClass}">${fmtPct(taxa)}</div>
            </div>
          </div>
        </div>
      </div>`;
    wrap.appendChild(card);
  });
}

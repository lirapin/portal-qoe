/* ================= UPLOAD FUNCIONAL ================= */
const dropArea = $('#dropArea');
const fileInput = $('#fileInput');

// Eventos de drag and drop CORRETOS
dropArea.addEventListener('dragenter', function(e) {
    e.preventDefault();
    dropArea.classList.add('dragover');
});

dropArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    dropArea.classList.add('dragover');
});

dropArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    dropArea.classList.remove('dragover');
});

dropArea.addEventListener('drop', function(e) {
    e.preventDefault();
    dropArea.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        showLoading();
        setTimeout(() => {
            handleFile(files[0]);
            hideLoading();
        }, 500);
    }
});

// Clique na área de upload
dropArea.addEventListener('click', function() {
    fileInput.click();
});

// Change do input file
fileInput.addEventListener('change', function(e) {
    const files = e.target.files;
    if (files.length > 0) {
        showLoading();
        setTimeout(() => {
            handleFile(files[0]);
            hideLoading();
        }, 500);
    }
});

/* ================= LEITURA DA PLANILHA ================= */
function handleFile(file) {
    console.log('Arquivo selecionado:', file.name);
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            
            console.log('Dados lidos:', jsonData);
            
            if (jsonData.length === 0) {
                showToast('❌ Planilha vazia', 'danger');
                return;
            }
            
            // Processar dados
            processData(jsonData);
            showToast(`✅ ${RAW.length} incidentes carregados`, 'success');
            
        } catch (error) {
            console.error('Erro ao processar arquivo:', error);
            showToast('❌ Erro ao processar a planilha', 'danger');
        }
    };
    
    reader.onerror = function() {
        showToast('❌ Erro ao ler o arquivo', 'danger');
    };
    
    reader.readAsArrayBuffer(file);
}

/* ================= PROCESSAMENTO DOS DADOS ================= */
function processData(jsonData) {
    // Encontrar linha do cabeçalho
    let headerRowIndex = -1;
    for (let i = 0; i < jsonData.length; i++) {
        if (Array.isArray(jsonData[i]) && jsonData[i].some(cell => String(cell).trim() !== '')) {
            headerRowIndex = i;
            break;
        }
    }
    
    if (headerRowIndex === -1) {
        showToast('❌ Nenhum cabeçalho encontrado', 'danger');
        return;
    }
    
    const rawHeaders = jsonData[headerRowIndex].map(normalizeHeader);
    const mappedHeaders = rawHeaders.map(h => AUTO_MAP[h] || h);
    
    console.log('Cabeçalhos mapeados:', mappedHeaders);
    
    // Processar linhas de dados
    const dataRows = jsonData.slice(headerRowIndex + 1).filter(row => 
        Array.isArray(row) && row.some(cell => String(cell).trim() !== '')
    );
    
    const processedData = dataRows.map(row => {
        const obj = {};
        mappedHeaders.forEach((header, index) => {
            obj[header] = row[index] || '';
        });
        
        // Processar campos especiais
        obj['Data'] = validarData(String(obj['Data'] || ''));
        obj['QOE_Pre'] = parseFloat(String(obj['QOE_Pre'] || '0').replace(',', '.')) || 0;
        obj['QOE_Pos'] = parseFloat(String(obj['QOE_Pos'] || '0').replace(',', '.')) || 0;
        obj['QOE_Pos_24h'] = parseFloat(String(obj['QOE_Pos_24h'] || '0').replace(',', '.')) || 0;
        
        // Garantir que campos de texto não estejam vazios
        ['Cluster', 'Node', 'Cidade', 'Tipo_Fechamento', 'INCIDENTE'].forEach(key => {
            obj[key] = String(obj[key] || '').trim() || '(não informado)';
        });
        
        return obj;
    });
    
    DATA_ALL = processedData;
    RAW = [...processedData];
    
    console.log('Dados processados:', RAW.slice(0, 3));
    
    // Renderizar todas as visualizações
    renderAll();
}

/* ================= FUNÇÕES AUXILIARES ================= */
function normalizeHeader(str) {
    return String(str || '')
        .trim()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .toUpperCase()
        .replace(/\s+/g, ' ');
}

function validarData(dataStr) {
    if (!dataStr || dataStr === '') return null;
    
    // Tentar parse como Date
    let data = new Date(dataStr);
    if (!isNaN(data.getTime())) return data;
    
    // Tentar formato brasileiro
    if (dataStr.includes('/')) {
        const partes = dataStr.split('/');
        if (partes.length === 3) {
            data = new Date(partes[2], partes[1] - 1, partes[0]);
            if (!isNaN(data.getTime())) return data;
        }
    }
    
    return null;
}

function showLoading() {
    hideLoading();
    const overlay = document.createElement('div');
    overlay.className = 'loading-overlay';
    overlay.id = 'loadingOverlay';
    overlay.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2 text-muted">Processando dados...</p>
        </div>
    `;
    document.querySelector('main').appendChild(overlay);
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.remove();
}

function showToast(message, type = 'info') {
    // Criar toast container se não existir
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
}

/* ================= MAPEAMENTO DE CABEÇALHOS ================= */
const AUTO_MAP = {
    'INCIDENTE': 'INCIDENTE',
    'CIDADE': 'Cidade',
    'CLUSTER': 'Cluster',
    'HI (DATA E HORA INÍCIO)': 'Data',
    'HI (DATA E HORA INICIO)': 'Data',
    'HI_INICIO': 'Data',
    'HI INICIO': 'Data',
    'HI INÍCIO': 'Data',
    'DATA': 'Data',
    'NODE': 'Node',
    'QOE PRÉ': 'QOE_Pre',
    'QOE PRE': 'QOE_Pre',
    'QOE_PRE': 'QOE_Pre',
    'QOE PÓS': 'QOE_Pos',
    'QOE POS': 'QOE_Pos',
    'QOE_POS': 'QOE_Pos',
    'QOE PÓS 24H': 'QOE_Pos_24h',
    'QOE POS 24H': 'QOE_Pos_24h',
    'QOE_POS_24H': 'QOE_Pos_24h',
    'SOLUÇÃO': 'Tipo_Fechamento',
    'SOLUCAO': 'Tipo_Fechamento',
    'TIPO_FECHAMENTO': 'Tipo_Fechamento'
};

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    console.log('Portal carregado - Upload pronto para uso');
    // Inicializar tooltips do Bootstrap se necessário
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
